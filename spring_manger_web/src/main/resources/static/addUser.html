<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta charset="utf-8"/>
    <title>注册</title>
    <link rel="stylesheet" href="assets/libs/layui/css/layui.css"/>
    <link rel="stylesheet" href="assets/css/login.css" media="all">
</head>

<body>
<div class="login-wrapper">

    <!--<div class="login-header">-->
    <!doctype html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport"
              content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Document</title>
    </head>
    <body>

    </body>
    </html>
    <!--</div>-->

    <div class="login-body">
        <div class="layui-card">
            <div class="layui-card-header">
                <i class="layui-icon layui-icon-engine"></i>&nbsp;&nbsp;用户注册
            </div>
            <form class="layui-card-body layui-form layui-form-pane">
                <div class="layui-form-item">
                    <label class="layui-form-label"></label>
                    <div class="layui-input-block">
                        <input type="text" name="name" required  lay-verify="required" placeholder="请输入用户名" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label"></label>
                    <div class="layui-input-block">
                        <input type="password" name="password" required lay-verify="required" placeholder="请输入密码" autocomplete="off" class="layui-input">
                    </div>

                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label"></label>
                    <div class="layui-input-block">
                        <input type="password" name="passwords" required lay-verify="required" placeholder="确认密码" autocomplete="off" class="layui-input">
                    </div>

                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label"></label>
                    <div class="layui-input-block">
                        <input type="text" name="phone" required lay-verify="required" placeholder="手机号" autocomplete="off" class="layui-input">
                    </div>

                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label"></label>
                    <div class="layui-input-block">
                        <input   type="text" name="yzm" placeholder="验证码" autocomplete="off" class="layui-input">

                    </div>
                    <div class="layui-input-block" >
                        <button style="background: #0C0C0C; vertical-align: middle" class="layui-btn" lay-submit lay-filter="formDemo">发送验证码</button>
                     </div>

                </div>

                <div class="layui-form-item">
                    <button lay-filter="login-submit" class="layui-btn layui-btn-fluid" lay-submit>登 录</button>
                </div>
            </form>
        </div>
    </div>
    <div class="login-footer">
        <p>© 2020 <a href="javascript:;" target="_blank">JeeCp版权所有</a></p>
    </div>
</div>

<script type="text/javascript" src="assets/libs/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="assets/libs/layui/layui.js"></script>
<script type="text/javascript" src="module/Math.uuid.js"></script>
<script>
    layui.config({
        base: 'module/'
    }).use(['config', 'form'], function () {
        var one  = 0;
        var two  = 0;
        var three  = 0;
        var name ="";
        var password ="";
        let uuid = Math.uuid();
        var $ = layui.jquery;
        $("input[name='deviceId']").val(uuid);
        var form = layui.form;
        var config = layui.config;
        if (config.getToken()) {
            location.replace('./');
            return;
        }
        function remoteUser(name){
            $.ajax({
                url:"http://localhost:8182/sumer/remoteUser",
                data:{
                    "name":name
                },
                type:"post",
                async:false,
                dataType: "JSON",
                success:function(data){

                    if(data.code!='200'){
                        alert(data.message);
                        one =1;
                    }else{
                        one = 0;
                    }
                },error:function(data){
                    alert("发生异常！");
                    return false;
                }
            })
        }
        function yzm(yzm,phone){
            $.ajax({
                url:"http://localhost:8282/sms/yzm",
                data:{
                    "yzm":yzm,
                    "phone":phone
                },
                type:"post",
                async:false,
                dataType: "JSON",
                success:function(data){
                    if(data.code!='200'){
                        alert(data.message);
                        three =1;
                    }else{
                        three = 0;
                    }
                },error:function(data){
                    alert("发生异常！");
                }
            })
        }
        function remoteUsers(phone){
            $.ajax({
                url:"http://localhost:8182/sumer/remoteUsers",
                data:{
                    "phone":phone
                },
                type:"post",
                async:false,
                dataType: "JSON",
                success:function(data){
                    if(data.code!='200'){
                        alert(data.message);
                        two =1;
                    }else{
                        two = 0;
                    }
                },error:function(data){
                    alert("发生异常！");
                }
            })
        }
        form.on('submit(formDemo)',function(obj){
            //alert(JSON.stringify(obj.field));
            var phone = obj.field.phone;
            $.ajax({
                url:"http://localhost:8282/sms/SendVerification",
                data:{
                    "phone":phone
                },
                type:"post",
                dataType:"JSON",
                success:function(data){
                    alert(data.message);
                },error:function(data){
                    alert("发生异常！")
                }
            });
            return false;
        })
        // 表单提交
        form.on('submit(login-submit)', function (obj) {
           var data = obj.field;
           remoteUser(data.name);
            if(data.password != data.passwords){
                alert("密码输入不一致！");
                return false;
            }
           remoteUsers(data.phone);
           yzm(data.yzm,data.phone);
           if(one==0 && two == 0 && three == 0){
               add(data)
               return false;
           }
           return false;

            //阻止表单跳转
        });
        function add(data){
            $.ajax({
                url:"http://localhost:8182/sumer/addUser",
                data:data,
                type:"post",
                dataType:"JSON",
                success:function(data){
                   if(data.code=='200'){
                     alert(data.message);
                     location.href="login.html";
                     return false;
                   }else{
                       alert(data.message);
                   }
                },error:function(data){
                    alert("发生异常！")
                }
            });
        }
    });
</script>
</body>
</html>